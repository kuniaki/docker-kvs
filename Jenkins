import hudson.tasks.test.AbstractTestResultAction
import hudson.model.Actionable
import hudson.tasks.junit.CaseResult
import hudson.util.DescribableList
import hudson.slaves.EnvironmentVariablesNodeProperty
import jenkins.model.Jenkins

properties(
    [
        parameters([
          string(name: 'branch', defaultValue: 'main', description: 'branch', ),
          string(name: 'node', defaultValue: 'DockerTest2', description: 'Jenkins Node Name', ),
        ])
    ]
)

node(node) {

 environment {
    DOCKERHUB_USER = "kuniaki0417"
    BUILD_HOST = "root@192.168.11.34"
    PROD_HOST = "root@192.168.11.35"
    BUILD_TIMESTAMP = sh(script: "date +%Y%m%d-%H%M%S", returnStdout: true).trim()
  }

//withCredentials([usernamePassword(credentialsId: '89fe8fc8-8b79-45d2-ba93-d444823bc168', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {  
//}
  try {

    stage('init') {
       sh '''
       git config --global user.name kuniaki
       git config --global user.email kuniaki.kudo@gmail.com
       '''

     //Clean up WORKSPACE
     step([$class: 'WsCleanup'])
    }

    stage('Checkout') {
       checkout scm: [
           $class: 'GitSCM', 
           extensions: [[$class: 'WipeWorkspace'],
                        [$class: 'CloneOption',
                         depth: 0,
                         honorRefspec: true,
                         noTags: false,
                         reference: '',
                          shallow: false]],
           userRemoteConfigs: [[url: 'https://github.com/kuniaki/docker-kvs.git',
                               refspec: '',
                               credentialsId: '89fe8fc8-8b79-45d2-ba93-d444823bc168']],
                               branches: [[name: branch]]], poll: false
    }

    stage('Build') {
        sh "cat docker-compose.build.yml"
        sh "docker-compose -f docker-compose.build.yml down"
        sh "docker volume prune -f"
        sh "docker-compose -f docker-compose.build.yml build"
        sh "docker-compose -f docker-compose.build.yml up -d"
        sh "docker-compose -f docker-compose.build.yml ps"
    }

    stage('Test') {
        sh "docker container exec dockerkvs_apptest pytest -v test_app.py"
        sh "docker container exec dockerkvs_webtest pytest -v test_static.py"
        sh "docker container exec dockerkvs_webtest pytest -v test_selenium.py"
        sh "docker-compose -f docker-compose.build.yml down"
    }
    
   def now = new Date()
   println now.format("yyMMdd.HHmm", TimeZone.getTimeZone('UTC'))
   def TIME_STAMP = now.format("yyMMdd.HHmm", TimeZone.getTimeZone('UTC'))
   
   stage('Register') {
      withCredentials([usernamePassword(credentialsId: '7590528a-50ac-4cb7-958b-54be5c0ffbb6', passwordVariable: 'PASSWORD', usernameVariable: 'USERNAME')]) { 
        sh "docker tag dockerkvs_web $USERNAME/web:$TIME_STAMP"
        sh "docker tag dockerkvs_app $USERNAME/app:$TIME_STAMP"
        sh "docker push $USERNAME/web:$TIME_STAMP"
        sh "docker push $USERNAME/app:$TIME_STAMP"
      }
    }

    stage('clear') {
      withCredentials([usernamePassword(credentialsId: '7590528a-50ac-4cb7-958b-54be5c0ffbb6', passwordVariable: 'PASSWORD', usernameVariable: 'USERNAME')]) { 
        sh "docker rmi $USERNAME/web:$TIME_STAMP"
        sh "docker rmi $USERNAME/app:$TIME_STAMP"
        sh "docker rmi `docker images -q`"
      }
   }


  } catch(e) {

  }

}
